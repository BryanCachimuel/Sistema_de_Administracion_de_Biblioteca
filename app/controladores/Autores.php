<?php class Autores extends Controlador{private $modelo="";private $usuario="";private $sesion;function __construct(){$this->sesion=new Sesion();if($this->sesion->getLogin()){$this->modelo=$this->modelo("AutoresModelo");$this->usuario=$this->sesion->getUsuario();}else{header("location:".RUTA);}}public function caratula($pagina=1){$num=$this->modelo->getNumRegistros();$inicio=($pagina-1)*TAMANO_PAGINA;$totalPaginas=ceil($num/TAMANO_PAGINA);$data=$this->modelo->getTabla($inicio,TAMANO_PAGINA);$datos=["titulo"=>"Autores","subtitulo"=>"Autores","activo"=>"autores","menu"=>true,"admon"=>ADMON,"pag"=>["totalPaginas"=>$totalPaginas,"regresa"=>"autores","pagina"=>$pagina],"data"=>$data];$this->vista("autoresCaratulaVista",$datos);}public function alta(){$data=[];$errores=array();$pag=1;if($_SERVER['REQUEST_METHOD']=="POST"){$id=$_POST['id']?? "";$pag=$_POST['pag']?? "1";$nombre=Helper::cadena($_POST['nombre']?? "");$apellidoPaterno=Helper::cadena($_POST['apellidoPaterno']?? "");$apellidoMaterno=Helper::cadena($_POST['apellidoMaterno']?? "");$idGenero=Helper::cadena($_POST['genero']?? "");$idPais=Helper::cadena($_POST['idPais']?? "");if(empty($nombre)){array_push($errores,"El nombre es requerido.");}if(empty($apellidoPaterno)){array_push($errores,"El apellido paterno es requerido.");}if($idGenero=="void"){array_push($errores,"El género es obligatorio.");}if($idPais=="void"){array_push($errores,"El país es obligatorio.");}if(empty($errores)){$data=["id"=>$id,"idPais"=>$idPais,"idGenero"=>$idGenero,"nombre"=>$nombre,"apellidoPaterno"=>$apellidoPaterno,"apellidoMaterno"=>$apellidoMaterno,"estado"=>""];if(trim($id)===""){if($this->modelo->alta($data)){$this->mensaje("Alta de un autor(a)","Alta de un autor(a)","Se añadió correctamente el autor(a): ".$nombre." ".$apellidoPaterno,"autores/".$pag,"success");}else{$this->mensaje("Error al añadir un autor(a).","Error al añadir un autor(a).","Error al modificar un autor(a): ".$nombre." ".$apellidoPaterno,"autores/".$pag,"danger");}}else{if($this->modelo->modificar($data)){$this->mensaje("Modificar un autor(a)","Modificar un autor(a)","Se modificó correctamente el autor(a): ".$nombre." ".$apellidoPaterno,"autores/".$pag,"success");}else{$this->mensaje("Error al modificar un autor(a).","Error al modificar un autor(a).","Error al modificar un autor(a): ".$nombre." ".$apellidoPaterno,"autores/".$pag,"danger");}}}}if(!empty($errores)||$_SERVER['REQUEST_METHOD']!="POST"){$paises=$this->modelo->getCatalogo("paises","pais");$genero=$this->modelo->getCatalogo("genero");$datos=["titulo"=>"Alta de un autor(a)","subtitulo"=>"Alta de un autor(a)","activo"=>"autores","menu"=>true,"admon"=>ADMON,"paises"=>$paises,"genero"=>$genero,"pag"=>$pag,"errores"=>$errores,"data"=>[]];$this->vista("autoresAltaVista",$datos);}}public function borrar($id="",$pag=1){$data=$this->modelo->getId($id);$paises=$this->modelo->getCatalogo("paises");$genero=$this->modelo->getCatalogo("genero");$ir_array=$this->modelo->getIntegridadReferencial($id);if($ir_array[0]==0){$datos=["titulo"=>"Baja de un autor(a)","subtitulo"=>"Baja de un autor(a)","menu"=>true,"admon"=>ADMON,"errores"=>[],"pag"=>$pag,"paises"=>$paises,"genero"=>$genero,"activo"=>'autores',"data"=>$data,"baja"=>true];$this->vista("autoresAltaVista",$datos);}else{$this->mensaje("Error al borrar un autor","Error al borrar un autor","No podemos eliminar el autor porque tiene:<ul><li>".$ir_array[0]." libros.</li></ul>Primero debe eliminar esas referencias.","autores","danger");}}public function bajaLogica($id='',$pag=1){if(isset($id)&&$id!=""){if($this->modelo->bajaLogica($id)){$this->mensaje("Borrar un autor(a)","Borrar un autor(a)","Se borró correctamente un autor(a).","autores/".$pag,"success");}else{$this->mensaje("Error al borrar un autor(a)","Error al borrar un autor(a)","Error al borrar un autor(a).","autores/".$pag,"danger");}}}public function estadoActualizar(){$errores=[];if($_SERVER['REQUEST_METHOD']=="POST"){$id=$_POST['id']?? "";$pag=$_POST['pag']?? "1";$estado=$_POST['estado']?? "void";if($estado=="void"){array_push($errores,"El género es obligatorio.");}if($id==1){$this->mensaje("Error al actualizar el estado del usuario","Error al actualizar el estado del usuario","No se puede cambiar el estado del administrador original.","usuarios/".$pag,"danger");array_push($errores,"No se puede cambiar el estado del administrador original.");}if(empty($errores)){if($this->modelo->estadoActualizar($id,$estado)){$this->mensaje("Actualizar el estado del usuario","Actualizar el estado del usuario","Se actualizó correctamente el estado del usuario.","usuarios/".$pag,"success");}else{$this->mensaje("Error al actualizar el estado del usuario","Error al actualizar el estado del usuario","Error al actualizar el estado del usuario.","usuarios/".$pag,"danger");}}}}public function estadoCambiar($id,$pag=1){$data=$this->modelo->getId($id);$estadosUsuario=$this->modelo->getCatalogo("estadosUsuario");$datos=["titulo"=>"Modificar el estado de un usuario","subtitulo"=>"Modificar el estado de un usuario","activo"=>"usuarios","menu"=>true,"admon"=>ADMON,"estadosUsuario"=>$estadosUsuario,"pag"=>$pag,"errores"=>[],"data"=>$data];$this->vista("usuariosEstadoCambiarVista",$datos);}public function modificar($id,$pag=1){$data=$this->modelo->getId($id);$paises=$this->modelo->getCatalogo("paises","pais");$genero=$this->modelo->getCatalogo("genero");$datos=["titulo"=>"Modificar un autor(a)","subtitulo"=>"Modificar un autor(a)","activo"=>"autores","menu"=>true,"admon"=>ADMON,"paises"=>$paises,"genero"=>$genero,"pag"=>$pag,"errores"=>[],"data"=>$data];$this->vista("autoresAltaVista",$datos);}public function autoresLibros($idAutor,$pag=1){$data=$this->modelo->getLibrosAutoresTabla($idAutor);$autor=$this->modelo->getId($idAutor);$nombre=$autor["nombre"]." ".$autor["apellidoPaterno"]." ".$autor["apellidoMaterno"];$datos=["titulo"=>"Libros","subtitulo"=>"Libros de: ".$nombre,"admon"=>ADMON,"activo"=>"autores","data"=>$data,"pag"=>$pag,"idAutor"=>$idAutor,"menu"=>true];$this->vista("autoresLibrosCaratulaVista",$datos);}public function autoresLibrosAlta($idAutor=""){$data=array();$errores=array();if($_SERVER['REQUEST_METHOD']=="POST"){$idLibro=Helper::cadena($_POST['idLibro']?? "");$pag=$_POST['pag']?? "1";$idAutor=$_POST['idAutor']?? "";if($idLibro=="void"){array_push($errores,"El autor es requerido.");}if(empty($errores)){$data=["idLibro"=>$idLibro,"idAutor"=>$idAutor,];if($this->modelo->autoresLibrosAlta($data)){$this->mensaje("El libro fue añadido.","El libro fue añadido.","El libro fue añadido.","autores/autoresLibros/".$idAutor."/".$pag,"success");}else{$this->mensaje("Error al registrar un libro.","Error al registrar un libro.","Error al registrar el libro: ","autores/".$pag,"danger");}}}if(!empty($errores)||$_SERVER['REQUEST_METHOD']!="POST"){$libros=$this->modelo->getLibros();$autor=$this->modelo->getId($idAutor);$nombre=$autor["nombre"]." ".$autor["apellidoPaterno"]." ".$autor["apellidoMaterno"];$datos=["titulo"=>"Dar de alta a un libro","subtitulo"=>"Dar de alta a un libro para ".$nombre,"activo"=>"autores","menu"=>false,"admon"=>ADMON,"errores"=>$errores,"idAutor"=>$idAutor,"data"=>$libros];$this->vista("autoresLibrosAltaVista",$datos);}}public function autoresLibrosQuitar($idLibroAutor="",$idAutor="",$pag=1){$data=$this->modelo->getIdLibrosAutores($idLibroAutor);$datos=["titulo"=>"Quitar una relación de autor-libro","subtitulo"=>"Quitar una relación de autor-libro","activo"=>"autores","menu"=>false,"admon"=>ADMON,"errores"=>[],"idAutor"=>$idAutor,"pag"=>$pag,"baja"=>true,"id"=>$idLibroAutor,"data"=>$data];$this->vista("autoresLibrosQuitarVista",$datos);}public function autoresLibrosBajaLogica($idLibroAutor='',$pag=1,$idAutor=""){if(isset($idLibroAutor)&&$idLibroAutor!=""){if($this->modelo->autoresLibrosBajaLogica($idLibroAutor)){$this->mensaje("Eliminó el libro del autor","Eliminó el libro del autor","Se eliminó correctamente el libro del autor.","autores/autoresLibros/".$idAutor."/".$pag,"success");}else{$this->mensaje("Error al borrar el libro del autor","Error al borrar el libro del autor","Error al borrar el libro del autor.","autores/".$pag,"danger");}}}public function copias($idLibro){if($idLibro=="")return false;$libro=$this->modelo->getLibro($idLibro);$copias=$this->modelo->copiasLibroTabla($idLibro);$datos=["titulo"=>"Copias de un libro","subtitulo"=>"Copias del libro: ".$libro["titulo"],"activo"=>"autores","menu"=>false,"admon"=>ADMON,"libro"=>$idLibro,"errores"=>[],"data"=>$copias];$this->vista("autoresLibrosCopiasCaratulaVista",$datos);}} ?>